@(rajobs: List[RAJob],
        pageNum: Integer,
        sort: String,
        offset: Integer,
        total: Integer,
        count: Integer,
        listType: String,
        pageLimit: Integer,
        searchBody: String,
        id: Long, beginIndexForPagination: Integer, endIndexForPagination: Integer)
@import helper._;
@import models._
@import models.RAJob
@import play.libs.Json

@scripts = {
    <script type = "module" src='@routes.Assets.at("javascripts/voiceJump.js")'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/assets/stylesheets/responsive-table.css">
            <script type="text/javascript">
        (function () {
            'use strict';

            function getJobsFromDom() {
                var el = document.getElementById('raJobsData');
                if (!el) return [];
                try {
                    return JSON.parse(el.getAttribute('data-rajobs') || '[]');
                } catch (e) {
                    console.error('Failed parsing RA jobs JSON from #raJobsData', e);
                    return [];
                }
            }

            function safeLower(value) {
                return (value || '').toString().toLowerCase();
            }

            function jumpToPage(pageNum, sort, searchString) {
                pageNum = parseInt(pageNum);
                var url = "/rajob/searchPOST?pageNum=" + pageNum + "&sortCriteria=" + sort;
                var form = document.createElement('form');
                form.action = url;
                form.method = 'POST';
                form.style.display = 'none';

                var searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.name = 'searchString';
                searchInput.value = searchString;

                form.appendChild(searchInput);
                document.body.appendChild(form);
                form.submit();
            }

            function string2Map(str) {
                var map = new Map();
                var splitedString = str.replace(new RegExp('],', 'g'), ';');
                var array = splitedString.split(';');
                for (var i = 0; i < array.length; i++) {
                    var idAndEventsString = array[i];
                    idAndEventsString = idAndEventsString.replace(/[{}\[\]\\]/g, ' ');
                    var idAndEvents = idAndEventsString.split('=');
                    var id = idAndEvents[0];
                    var eventsString = idAndEvents[1];
                    if (!eventsString) continue;
                    var events = eventsString.split(',');

                    var formatedEvents = '';
                    for (var j = 0; j < events.length; j++) {
                        events[j] = events[j].trim();
                        formatedEvents = formatedEvents + events[j] + ';';
                    }
                    if (formatedEvents.length > 1) {
                        map.set(id.trim(), formatedEvents);
                    }
                }
                return map;
            }

            function populateFilter(selectElement, values, previousValue) {
                if (!selectElement) return;
                var currentSelection = previousValue || selectElement.value || '';
                var options = '<option value="">All</option>';
                Array.from(values).sort().forEach(function (value) {
                    options += '<option value="' + value + '">' + value + '</option>';
                });
                selectElement.innerHTML = options;
                if (values.has(currentSelection)) {
                    selectElement.value = currentSelection;
                }
            }

            function updateFilterOptions(filters) {
                var departments = new Set((filters && filters.departments) || []);
                var modes = new Set((filters && filters.modes) || []);
                var statuses = new Set((filters && filters.statuses) || []);

                populateFilter(document.getElementById('departmentFilter'), departments);
                populateFilter(document.getElementById('modeFilter'), modes);
                populateFilter(document.getElementById('statusFilter'), statuses);
            }

            function destroyChartIfExists(chartInstance) {
                if (chartInstance) chartInstance.destroy();
            }

            var payBarChart = null;
            var payPieChart = null;
            var deptBarChart = null;

            function renderDepartmentChart(departments, counts) {
                var canvas = document.getElementById('deptBarChart');
                var fallbackText = document.getElementById('deptChartFallback');

                if (!canvas || !fallbackText) return;

                var total = counts.reduce(function (sum, value) { return sum + value; }, 0);

                if (total === 0 || departments.length === 0) {
                    canvas.style.display = 'none';
                    fallbackText.style.display = 'block';
                    fallbackText.textContent = 'No jobs found for the selected filters.';
                    destroyChartIfExists(deptBarChart);
                    deptBarChart = null;
                    return;
                }

                canvas.style.display = 'block';
                fallbackText.style.display = 'none';

                var colors = departments.map(function (dept, index) {
                    var hue = (index * 137.5) % 360;
                    return 'hsl(' + hue + ', 65%, 55%)';
                });

                var hoverColors = departments.map(function (dept, index) {
                    var hue = (index * 137.5) % 360;
                    return 'hsl(' + hue + ', 65%, 45%)';
                });

                var config = {
                    type: 'bar',
                    data: {
                        labels: departments,
                        datasets: [{
                            label: 'Jobs by department',
                            data: counts,
                            backgroundColor: colors,
                            hoverBackgroundColor: hoverColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var value = context.parsed.y || 0;
                                        var percent = total ? ((value / total) * 100).toFixed(1) : '0.0';
                                        return context.label + ': ' + value + ' job' + (value === 1 ? '' : 's') + ' (' + percent + '%)';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 },
                                title: { display: true, text: 'Number of jobs' }
                            },
                            x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                        }
                    }
                };

                if (deptBarChart) {
                    deptBarChart.data.labels = departments;
                    deptBarChart.data.datasets[0].data = counts;
                    deptBarChart.update();
                } else {
                    deptBarChart = new Chart(canvas.getContext('2d'), config);
                }
            }

            function fetchDepartmentData() {
                var filters = {
                    department: document.getElementById('departmentFilter')?.value || '',
                    mode: document.getElementById('modeFilter')?.value || '',
                    status: document.getElementById('statusFilter')?.value || ''
                };

                var params = new URLSearchParams();
                Object.keys(filters).forEach(function (key) {
                    if (filters[key]) params.append(key, filters[key]);
                });

                var url = '/rajob/byDepartment';
                if (params.toString()) url += '?' + params.toString();

                fetch(url)
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        var departments = data.departments || [];
                        var counts = data.counts || [];
                        renderDepartmentChart(departments, counts);
                    })
                    .catch(function (error) {
                        console.error('Error fetching department data:', error);
                        var fallbackText = document.getElementById('deptChartFallback');
                        var canvas = document.getElementById('deptBarChart');
                        if (fallbackText) {
                            fallbackText.style.display = 'block';
                            fallbackText.textContent = 'Unable to load department data.';
                        }
                        if (canvas) canvas.style.display = 'none';
                        destroyChartIfExists(deptBarChart);
                        deptBarChart = null;
                    });
            }

            function renderPayScaleCharts(counts) {
                var hourly = (counts && counts.hourly) || 0;
                var fullTime = (counts && counts.fullTime) || 0;

                var labels = ['Hourly RA ($20/hr grad, $15/hr undergrad)', 'Full-time RA ($2500/month + tuition waiver)'];
                var data = [hourly, fullTime];
                var total = data.reduce(function (sum, value) { return sum + value; }, 0);

                var barCanvas = document.getElementById('payBarChart');
                var pieCanvas = document.getElementById('payPieChart');
                var fallbackText = document.getElementById('payChartFallback');

                if (!barCanvas || !pieCanvas || !fallbackText) return;

                if (total === 0) {
                    barCanvas.style.display = 'none';
                    pieCanvas.style.display = 'none';
                    fallbackText.style.display = 'block';
                    fallbackText.textContent = 'No pay scale data available for the selected filters.';
                    destroyChartIfExists(payBarChart);
                    destroyChartIfExists(payPieChart);
                    payBarChart = null;
                    payPieChart = null;
                    return;
                }

                barCanvas.style.display = 'block';
                pieCanvas.style.display = 'block';
                fallbackText.style.display = 'none';

                var barConfig = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jobs by pay scale',
                            data: data,
                            backgroundColor: ['#64b5f6', '#ffb74d'],
                            hoverBackgroundColor: ['#42a5f5', '#ffa726']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var value = context.parsed.y || 0;
                                        return context.label + ': ' + value + ' job' + (value === 1 ? '' : 's');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Number of jobs' } }
                        }
                    }
                };

                var pieConfig = {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jobs by pay scale',
                            data: data,
                            backgroundColor: ['#64b5f6', '#ffb74d'],
                            hoverBackgroundColor: ['#42a5f5', '#ffa726']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        var value = context.parsed || 0;
                                        var percent = total ? ((value / total) * 100).toFixed(1) : 0;
                                        return context.label + ': ' + value + ' job' + (value === 1 ? '' : 's') + ' (' + percent + '%)';
                                    }
                                }
                            }
                        }
                    }
                };

                if (payBarChart) {
                    payBarChart.data.datasets[0].data = data;
                    payBarChart.update();
                } else {
                    payBarChart = new Chart(barCanvas.getContext('2d'), barConfig);
                }

                if (payPieChart) {
                    payPieChart.data.datasets[0].data = data;
                    payPieChart.update();
                } else {
                    payPieChart = new Chart(pieCanvas.getContext('2d'), pieConfig);
                }
            }

            function fetchPayScaleData() {
                var filters = {
                    department: document.getElementById('departmentFilter')?.value || '',
                    mode: document.getElementById('modeFilter')?.value || '',
                    status: document.getElementById('statusFilter')?.value || ''
                };

                var params = new URLSearchParams();
                Object.keys(filters).forEach(function (key) {
                    if (filters[key]) params.append(key, filters[key]);
                });

                var url = '/rajob/payRanges';
                if (params.toString()) url += '?' + params.toString();

                fetch(url)
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        var counts = (data && data.counts) || {};
                        var filtersPayload = (data && data.filters) || {};
                        updateFilterOptions(filtersPayload);
                        renderPayScaleCharts(counts);
                    })
                    .catch(function () {
                        var fallbackText = document.getElementById('payChartFallback');
                        var barCanvas = document.getElementById('payBarChart');
                        var pieCanvas = document.getElementById('payPieChart');
                        if (fallbackText) {
                            fallbackText.style.display = 'block';
                            fallbackText.textContent = 'Unable to load pay scale data.';
                        }
                        if (barCanvas) barCanvas.style.display = 'none';
                        if (pieCanvas) pieCanvas.style.display = 'none';
                        destroyChartIfExists(payBarChart);
                        destroyChartIfExists(payPieChart);
                        payBarChart = null;
                        payPieChart = null;
                    });
            }

            function resetPayScaleFilters() {
                var d = document.getElementById('departmentFilter');
                var m = document.getElementById('modeFilter');
                var s = document.getElementById('statusFilter');
                if (d) d.value = '';
                if (m) m.value = '';
                if (s) s.value = '';
                fetchPayScaleData();
                fetchDepartmentData();
            }

            function exportChart(chartInstance, filename) {
                if (!chartInstance) return;
                var link = document.createElement('a');
                link.href = chartInstance.toBase64Image();
                link.download = filename;
                link.click();
            }

            var KEYWORD_STOP_WORDS = new Set([
                'the', 'a', 'an', 'and', 'or', 'for', 'to', 'of', 'in', 'on', 'with',
                'at', 'by', 'from', 'is', 'are', 'this', 'that', 'as', 'be', 'it',
                'job', 'jobs', 'ra', 'research', 'assistant', 'position'
            ]);

            function getFilteredJobsClientSide() {
                var jobs = getJobsFromDom();

                var deptFilter = safeLower(document.getElementById('departmentFilter')?.value || '');
                var modeFilter = safeLower(document.getElementById('modeFilter')?.value || '');
                var statusFilter = safeLower(document.getElementById('statusFilter')?.value || '');
                var q = safeLower(document.getElementById('jobSearch')?.value || '').trim();

                return jobs.filter(function (job) {
                    var jobDept = safeLower(job.fields || '');
                    var jobMode = safeLower(job.location || '');
                    var jobStatus = safeLower(job.status || '');

                    if (deptFilter && !jobDept.includes(deptFilter)) return false;
                    if (modeFilter && !jobMode.includes(modeFilter)) return false;
                    if (statusFilter && !jobStatus.includes(statusFilter)) return false;

                    if (q) {
                        var blob = [
                            job.title, job.goals, job.shortDescription, job.longDescription,
                            job.fields, job.location, job.requiredExpertise, job.preferredExpertise
                        ].filter(Boolean).join(' ').toLowerCase();
                        if (!blob.includes(q)) return false;
                    }
                    return true;
                });
            }

            function renderKeywordPanel(entries) {
                var listEl = document.getElementById('keywordList');
                var emptyEl = document.getElementById('keywordEmpty');
                if (!listEl || !emptyEl) return;

                listEl.innerHTML = '';

                if (!entries || entries.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }
                emptyEl.style.display = 'none';

                entries.forEach(function (pair) {
                    var keyword = pair[0];
                    var count = pair[1];
                    var li = document.createElement('li');
                    li.className = 'collection-item';
                    li.innerHTML =
                        '<span class="left">' + keyword + '</span>' +
                        '<span class="secondary-content grey-text text-darken-1">' + count + '</span>';
                    listEl.appendChild(li);
                });
            }

            function buildKeywordStatsFromJobs() {
                var jobs = getFilteredJobsClientSide();

                var freq = {};
                jobs.forEach(function (job) {
                    var parts = [];
                    if (job.title) parts.push(job.title);
                    if (job.goals) parts.push(job.goals);
                    if (job.shortDescription) parts.push(job.shortDescription);
                    if (job.longDescription) parts.push(job.longDescription);
                    if (job.fields) parts.push(job.fields);
                    if (job.location) parts.push(job.location);
                    if (job.requiredExpertise) parts.push(job.requiredExpertise);
                    if (job.preferredExpertise) parts.push(job.preferredExpertise);

                    var text = parts.join(' ').toLowerCase();
                    text = text.replace(/[^a-z0-9\s]/g, ' ');
                    var tokens = text.split(/\s+/);

                    tokens.forEach(function (token) {
                        if (!token) return;
                        if (KEYWORD_STOP_WORDS.has(token)) return;
                        if (token.length < 2) return;
                        freq[token] = (freq[token] || 0) + 1;
                    });
                });

                var entries = Object.entries(freq)
                    .sort(function (a, b) { return b[1] - a[1]; })
                    .slice(0, 10);

                renderKeywordPanel(entries);
            }

            function updateSummaryAndEmptyState() {
                var totalEl = document.getElementById('summaryTotalJobs');
                var deptEl = document.getElementById('summaryDeptCount');
                var avgEl = document.getElementById('summaryAvgPay');
                var noEl = document.getElementById('noJobsFoundMsg');

                if (!totalEl || !deptEl || !avgEl || !noEl) return;

                var filtered = getFilteredJobsClientSide();

                totalEl.textContent = filtered.length.toString();

                var deptSet = new Set();
                filtered.forEach(function (j) {
                    var d = (j.organization || j.fields || 'Unknown').toString().trim();
                    if (d) deptSet.add(d);
                });
                deptEl.textContent = deptSet.size.toString();

                var sum = 0, count = 0;
                filtered.forEach(function (j) {
                    var min = Number(j.minSalary || 0);
                    var max = Number(j.maxSalary || 0);
                    if (max > 0) {
                        sum += (min + max) / 2;
                        count += 1;
                    }
                });
                avgEl.textContent = count ? ('$' + (sum / count).toFixed(2)) : '--';

                var noJobs = filtered.length === 0;
                noEl.style.display = noJobs ? 'block' : 'none';
            }

            function applyViewMode() {
                var mode = document.getElementById('viewMode')?.value || 'all';
                var pay = document.getElementById('paySection');
                var dept = document.getElementById('deptSection');
                var kw = document.getElementById('keywordSection');

                if (!pay || !dept || !kw) return;

                pay.style.display = 'none';
                dept.style.display = 'none';
                kw.style.display = 'none';

                if (mode === 'all') {
                    pay.style.display = 'block';
                    dept.style.display = 'block';
                    kw.style.display = 'block';
                } else if (mode === 'pay') {
                    pay.style.display = 'block';
                } else if (mode === 'dept') {
                    dept.style.display = 'block';
                } else if (mode === 'keywords') {
                    kw.style.display = 'block';
                }

                if (mode === 'all' || mode === 'pay') {
                    if (payBarChart) payBarChart.update();
                    if (payPieChart) payPieChart.update();
                }
                if (mode === 'all' || mode === 'dept') {
                    if (deptBarChart) deptBarChart.update();
                }
            }

            function initVoiceJumpData() {
                var jobs = getJobsFromDom();
                var technologiesArray = jobs.map(function (j) {
                    var id = j.id || j._id || j.rajobId || '';
                    var title = (j.title || '').toString();
                    return {
                        id: id,
                        url: "/rajob/rajobDetail/" + id,
                        name: title.replace(/[^a-zA-Z0-9]/g, ' ').replace(/  +/g, ' ').trim()
                    };
                });

                var nasaText = document.getElementById('nasaText');
                if (nasaText) nasaText.textContent = JSON.stringify(technologiesArray);

                try {
                    if (window.$ && typeof window.$ === 'function') {
                        window.$('.tooltipped').tooltip();
                    }
                } catch (e) {
                    /* ignore */
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                initVoiceJumpData();

                var resetButton = document.getElementById('payScaleReset');
                var exportBarButton = document.getElementById('exportPayBarChart');
                var exportPieButton = document.getElementById('exportPayPieChart');
                var exportDeptButton = document.getElementById('exportDeptBarChart');

                var departmentFilter = document.getElementById('departmentFilter');
                var modeFilter = document.getElementById('modeFilter');
                var statusFilter = document.getElementById('statusFilter');

                if (resetButton) {
                    resetButton.addEventListener('click', function () {
                        resetPayScaleFilters();
                        buildKeywordStatsFromJobs();
                        updateSummaryAndEmptyState();
                        applyViewMode();
                    });
                }

                if (exportBarButton) exportBarButton.addEventListener('click', function () { exportChart(payBarChart, 'ra-pay-scale-bar.png'); });
                if (exportPieButton) exportPieButton.addEventListener('click', function () { exportChart(payPieChart, 'ra-pay-scale-pie.png'); });
                if (exportDeptButton) exportDeptButton.addEventListener('click', function () { exportChart(deptBarChart, 'ra-jobs-by-department.png'); });

                [departmentFilter, modeFilter, statusFilter].forEach(function (select) {
                    if (!select) return;
                    select.addEventListener('change', function () {
                        fetchPayScaleData();
                        fetchDepartmentData();
                        buildKeywordStatsFromJobs();
                        updateSummaryAndEmptyState();
                    });
                });

                var jobSearch = document.getElementById('jobSearch');
                if (jobSearch) {
                    jobSearch.addEventListener('input', function () {
                        buildKeywordStatsFromJobs();
                        updateSummaryAndEmptyState();
                    });
                }

                var viewMode = document.getElementById('viewMode');
                if (viewMode) viewMode.addEventListener('change', applyViewMode);

                fetchPayScaleData();
                fetchDepartmentData();
                setTimeout(function () {
                    buildKeywordStatsFromJobs();
                    updateSummaryAndEmptyState();
                    applyViewMode();
                }, 200);
            });

            window.jumpToPage = jumpToPage;
            window.string2Map = string2Map;
        })();

    </script>

    <style>
            .follow-fab {
                top: -20px !important;
                bottom: auto !important;
                right: -20px !important;
            }

            .truncate-text {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                max-height: 4.5em; /* 3 lines approx if line-height is 1.5em */
                line-height: 1.5em;
                cursor: pointer;
                white-space: normal;
            }

            .pay-range-card {
                margin-top: 20px;
            }

            .pay-range-card h5 {
                margin-top: 0;
                margin-bottom: 10px;
            }

            .pay-range-description {
                margin-bottom: 16px;
            }

            .pay-filter-select {
                margin-bottom: 12px;
            }

            .filter-actions {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 8px;
            }

            .summary-metrics-row {
                margin-top: 8px;
            }

            .summary-metric {
                padding: 12px 8px;
            }

            .summary-label {
                font-size: 0.85rem;
                font-weight: 600;
                letter-spacing: 0.02em;
                color: #616161;
                text-transform: uppercase;
            }

            .summary-value {
                font-size: 2rem;
                font-weight: 700;
                color: #1a237e;
                margin-top: 4px;
            }

            .overview-card .input-field {
                margin-top: 0;
            }

            .dept-chart-wrapper {
                margin-top: 16px;
            }

    </style>
}

@main("All RA Jobs", scripts) {
    <div id="raJobsData"
     data-rajobs='@Html(Json.toJson(rajobs).toString())'
     style="display:none;"></div>

    <div class="container">
        <div class="card-panel center">
            @if(listType.equals("search")) {
                <div class="row card-panel z-depth-0 project-zone-panel">
                    <div class="col s12" style="margin-top: -10px;
                        margin-bottom: -10px;">
                        <h6 class="center tooltipped" data-position="bottom" data-tooltip="This list shows the search results." >
                            Search Result
                        </h6>
                    </div>
                </div>
            }else if (listType.equals("all")) {
            <div class="row card-panel z-depth-0 project-zone-panel">
                <div class="col s12" style="margin-top: -10px;
                    margin-bottom: -10px;">
                    <h6 class="center tooltipped" data-position="bottom" data-tooltip="This list shows all the RA jobs." >
                        List of RA Jobs Posted at SMU-Lyle-Sci-Hub
                    </h6>
                </div>
            </div>
            }

            @if(rajobs.size() > 0) {
                <div class="col s8 offset-s2">
                    <h4>RA Job List</h4>

                </div>
                <div class="col s2">
                    <button id = "speak-from-filter" hidden></button>
                    <div id="nasaText" hidden></div>
                    <div id="requestField"></div>
                    <div id="replyField"></div>
                </div>
                <div class="row overview-card">
                    <div class="col s12">
                        <div class="card-panel">
                            <div class="row">
                                <div class="col s12 m8">
                                    <h5>RA jobs overview</h5>
                                    <p class="grey-text text-darken-1">
                                        Quick stats, search, and visualization controls for all research assistant postings.
                                    </p>
                                </div>
                                <div class="col s12 m4">
                                    <div class="input-field">
                                        <label for="jobSearch" class="active">Search jobs</label>
                                        <input type="text" id="jobSearch" placeholder="Filter by keywords, skills, or departments" />
                                    </div>
                                    <div class="input-field">
                                        <label for="viewMode" class="active">View mode</label>
                                        <select id="viewMode" class="browser-default">
                                            <option value="all">Show all</option>
                                            <option value="pay">Pay overview</option>
                                            <option value="dept">Departments</option>
                                            <option value="keywords">Keywords</option>
                                            <option value="summary">Summary only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row summary-metrics-row">
                                <div class="col s12 m4">
                                    <div class="summary-metric card-panel grey lighten-4 center">
                                        <div class="summary-label">Total jobs</div>
                                        <div class="summary-value" id="summaryTotalJobs">@rajobs.size()</div>
                                    </div>
                                </div>
                                <div class="col s12 m4">
                                    <div class="summary-metric card-panel grey lighten-4 center">
                                        <div class="summary-label">Departments hiring</div>
                                        <div class="summary-value" id="summaryDeptCount">--</div>
                                    </div>
                                </div>
                                <div class="col s12 m4">
                                    <div class="summary-metric card-panel grey lighten-4 center">
                                        <div class="summary-label">Average posted pay</div>
                                        <div class="summary-value" id="summaryAvgPay">--</div>
                                    </div>
                                </div>
                            </div>
                            <p id="noJobsFoundMsg" class="red-text text-darken-2" style="display: none;">
                                No jobs found for the current filters or search.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="row pay-range-card" id="paySection">
                    <div class="col s12">
                        <div class="card-panel">
                            <div class="row">
                                <div class="col s12 m8">
                                    <h5>Pay scale overview</h5>
                                    <p class="grey-text text-darken-1 pay-range-description">
                                        See how RA postings distribute between hourly (grad/undergrad) and full-time positions.
                                    </p>
                                    <div class="row">
                                        <div class="col s12 m6">
                                            <canvas id="payBarChart" role="img" aria-label="Research assistant pay scale bar chart"></canvas>
                                        </div>
                                        <div class="col s12 m6">
                                            <canvas id="payPieChart" role="img" aria-label="Research assistant pay scale pie chart"></canvas>
                                        </div>
                                    </div>
                                    <p id="payChartFallback" class="grey-text text-darken-1" style="display: none;">Loading pay scale data...</p>
                                </div>
                                <div class="col s12 m4">
                                    <div class="input-field">
                                        <label for="departmentFilter" class="active">Department / Lab</label>
                                        <select id="departmentFilter" class="browser-default pay-filter-select">
                                            <option value="">All</option>
                                        </select>
                                    </div>
                                    <div class="input-field">
                                        <label for="modeFilter" class="active">Mode / Location</label>
                                        <select id="modeFilter" class="browser-default pay-filter-select">
                                            <option value="">All</option>
                                        </select>
                                    </div>
                                    <div class="input-field">
                                        <label for="statusFilter" class="active">Status</label>
                                        <select id="statusFilter" class="browser-default pay-filter-select">
                                            <option value="">All</option>
                                        </select>
                                    </div>
                                    <div class="filter-actions">
                                        <button type="button" class="btn grey lighten-2 black-text" id="payScaleReset">Reset filters</button>
                                        <button type="button" class="btn blue darken-1" id="exportPayBarChart" aria-label="Export pay scale bar chart image">Export bar chart</button>
                                        <button type="button" class="btn blue darken-1" id="exportPayPieChart" aria-label="Export pay scale pie chart image">Export pie chart</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row dept-chart-wrapper" id="deptSection">
                    <div class="col s12">
                        <div class="card-panel">
                            <h5>Jobs by Department</h5>
                            <p class="grey-text text-darken-1 pay-range-description">
                                Distribution of RA job postings across different departments and labs.
                            </p>
                            <div class="row">
                                <div class="col s12">
                                    <canvas id="deptBarChart" role="img" aria-label="Jobs by department bar chart" style="max-height: 400px;"></canvas>
                                    <p id="deptChartFallback" class="grey-text text-darken-1" style="display: none;">Loading department data...</p>
                                </div>
                            </div>
                            <div class="filter-actions">
                                <button type="button" class="btn green darken-1" id="exportDeptBarChart" aria-label="Export department chart image">Export chart</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="keywordSection">
                    <div class="col s12">
                      <div class="card-panel">
                        <h5>Top keywords</h5>
                        <p class="grey-text text-darken-1">
                          Most common words in titles, fields, and descriptions for the RA jobs in this list.
                        </p>
                        <ul class="collection" id="keywordList"></ul>
                        <p id="keywordEmpty"
                           class="grey-text text-darken-1"
                           style="display:none;">
                          No keywords to display.
                        </p>
                      </div>
                    </div>
                  </div>
                <div class="row">
                    <div class="col s6">
                        <h6 class="left">Showing results: @{
                            offset + 1
                        } to @{
                            offset + count
                        } of @total</h6>
                    </div>
                    <div class="col s6" style="padding-top: -5px;
                        margin-top: -2px">
                        <a class='dropdown-trigger btn-flat right' href='#' data-target='dropdown2' style="text-transform: none;
                            font-weight: bold;
                            color: black;
                            font-family: AmazonEmberBold, Helvetica Neue Bold, Helvetica Neue, Helvetica, Arial, sans-serif;
                        !important; ">
                            Sort By: &nbsp; <font color="#3a5dc3">
                            @if(sort.equals("id")) {
                                Job ID
                            }else if(sort.equals("jobTitle")){
                        Job Title
                        }else {
                        Job Keywords
                        }</font> <i class="material-icons right">expand_more</i></a>

                            <!-- Dropdown Structure -->
                        <ul id='dropdown2' class='dropdown-content'>
                        @if(listType.equals("all")) {
                            <li><a href="@routes.RAJobController.rajobList(1, "id")" class="grey-text text-darken-4"><i class="material-icons">
                                event</i>Job ID</a></li>
                            <li><a href="@routes.RAJobController.rajobList(1, "title")" class="grey-text text-darken-4"><i class="material-icons">
                                sort_by_alpha</i>Job Title </a></li>
                            <li><a href="@routes.RAJobController.rajobList(1, "fields")" class="grey-text text-darken-4"><i class="material-icons">
                                sort_by_alpha</i>Job Fields </a></li>
                        }else {
                            <li>
                                <a onclick="jumpToPage(1, 'id', '@searchBody')">
                                    <i class="material-icons">event</i>Job ID
                                </a>
                            </li>
                            <li>
                                <a onclick="jumpToPage(1, 'title', '@searchBody')">
                                    <i class="material-icons">sort_by_alpha</i>Job Title
                                </a>
                            </li>
                            <li>
                                <a onclick="jumpToPage(1, 'location', '@searchBody')">
                                    <i class="material-icons">sort_by_alpha</i>Job Location
                                </a>
                            </li>
                        }
                        </ul>
                    </div>
                </div>
                <div class="desktop-table-view">
                    <div class="table-responsive">
                        <table class="centered responsive-table striped" id="projectTable" >
                            <thead>
                                <tr class="list-header" style="border-bottom: 1px solid;
                                !important;">
                                    <th style="cursor: pointer;">RA Job Id</th>
                                    <th style="cursor: pointer;">Title</th>
                                    <th style="cursor: pointer;">Short Description</th>
                                    <th style="cursor: pointer;">Fields</th>
                                    <th style="cursor: pointer;">Status</th>
                                    <th style="cursor: pointer;">updateTime</th>
                                </tr>
                            </thead>
                            <tbody>
                            @for((entry, index) <- rajobs.zipWithIndex if entry.getStatus() != "closed" ) {
                                <tr>
                                    <td>@entry.getId()</td>

                                    @*                            @if(entry.getTitle() != "") {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='title'></span>*@
                                    @*                                    @entry.getTitle()*@
                                    @*                                </td>*@
                                    @*                            } else {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='title'>&ensp; -</span></td>*@
                                    @*                            }*@

                                    @*                            @if(entry.getShortDescription() != "") {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='shortDescription'></span>*@

                                    @*                                    @entry.getShortDescription()*@
                                    @*                                </td>*@
                                    @*                            } else {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='shortDescription'>&ensp; -</span></td>*@
                                    @*                            }*@



                                    @*                            @if(entry.getFields() != "") {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='fields'></span>*@

                                    @*                                    @entry.getFields()*@
                                    @*                                </td>*@
                                    @*                            } else {*@
                                    @*                                <td><span class="@entry.getId() editable" data-name='fields'>&ensp; -</span></td>*@
                                    @*                            }*@
                                    <td>
                                    @if(entry.getTitle() != null && entry.getTitle().nonEmpty) {
                                        <a href="@routes.RAJobController.rajobDetail(entry.getId())">@entry.getTitle()</a>
                                        <span class="@entry.getId() editable" data-name="title"></span>
                                        @*                                    @if(entry.getTitle().length > 30) {*@
                                        @*                                        @entry.getTitle().substring(0, 30)...*@
                                        @*                                    } else {*@
                                        @*                                        @entry.getTitle()*@
                                        @*                                    }*@
                                    } else {
                                        <span class="@entry.getId() editable" data-name="title">&ensp; -</span>
                                    }
                                    </td>

                                    <td>

                                    @if(entry.getShortDescription() != null && entry.getShortDescription().nonEmpty) {
                                        <span class="@entry.getId() editable truncate-text" data-name="shortDescription" title="@entry.getShortDescription()" >
                                        @entry.getShortDescription()
                                        </span>
                                    } else {
                                        <span class="@entry.getId() editable truncate-text" data-name="shortDescription">&ensp; -</span>
                                    }
                                    </td>

                                    <td>
                                    @if(entry.getFields() != null && entry.getFields().nonEmpty) {
                                        <span class="@entry.getId() editable truncate-text" data-name="fields" title="@entry.getFields()">
                                            @*                                    @if(entry.getFields().length > 20) {*@
                                            @*                                        @entry.getFields().substring(0, 20)...*@
                                            @*                                    } else {*@
                                            @*                                        @entry.getFields()*@
                                            @*                                    }*@
                                            @entry.getFields()
                                        </span>
                                    } else {
                                        <span class="@entry.getId() editable truncate-text" data-name="fields">&ensp; -</span>
                                    }
                                    </td>


                                    @if(entry.getStatus() == "open") {
                                        <td>
                                            <span class="new badge light-green darken-1" data-badge-caption="open"></span>
                                        </td>
                                    } else if(entry.getStatus() == "pending"){
                                    <td>
                                        <span class="new badge purple darken-1" data-badge-caption="pending"></span>
                                    </td>
                                    @*                            }else if(entry.getStatus() == "closed"){*@
                                    @*                                <td>*@
                                    @*                                    <span class="new badge grey darken-3" data-badge-caption="closed"></span>*@
                                    @*                                </td>*@
                                    }else{
                                    <td>
                                        <span class="new badge blue darken-3" data-badge-caption="updated"></span>
                                    </td>
                                    }
                                    @if(entry.getUpdateTime() != "") {
                                        <td><span class="@entry.getId() editable" data-name='updateTime'></span>
                                            @entry.getUpdateTime()
                                        </td>
                                    } else {
                                        <td><span class="@entry.getId() editable" data-name='updateTime'>&ensp; -</span></td>
                                    }
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>

                    <!-- Mobile Cards for RAJob List -->
                <div class="mobile-table-view">
                @for(entry <- rajobs.asScala) {
                    <div class="card-panel z-depth-1" style="margin-bottom: 16px;">

                            <!-- RA Job Id -->
                        <div><h6>RA Job Id:</h6> @entry.getId()</div>

                            <!-- Title -->
                        <div><h6>Title:</h6>
                            @if(entry.getTitle() != null && entry.getTitle().nonEmpty) {
                                <a href="@routes.RAJobController.rajobDetail(entry.getId())">
                                @entry.getTitle()
                                </a>
                            } else {
                                <span>&ensp; -</span>
                            }
                        </div>

                            <!-- Short Description (Truncated if too long) -->
                        <div><h6>Short Description:</h6>
                            @{
                                val desc = Option(entry.getShortDescription).getOrElse("")
                                val words = desc.split("\\s+")
                                if (words.length > 30) words.take(30).mkString(" ") + "..." else desc
                            }
                        </div>

                            <!-- Fields (Truncated if too long) -->
                        <div><h6>Fields:</h6>
                            @{
                                val fields = Option(entry.getFields).getOrElse("")
                                if (fields.length > 50) fields.take(50) + "..." else fields
                            }
                        </div>

                            <!-- Status -->
                        <div><h6>Status:</h6> @entry.getStatus()</div>

                            <!-- Update Time -->
                        <div><h6>Update Time:</h6>
                            @if(entry.getUpdateTime() != null && entry.getUpdateTime().nonEmpty) {
                                @entry.getUpdateTime()
                            } else {
                                <span>&ensp; -</span>
                            }
                        </div>

                    </div>
                }
                </div>

                <div class="row">
                    <div class="col s12">
                        <ul class="pagination center-align">

                            @if(listType.equals("all")) {
                                @if(pageNum == 1) {
                                    <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                        first_page</i></li>
                                    <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                        chevron_left</i></li>
                                } else {
                                    <li class="waves-effect"><a href="@routes.RAJobController.rajobList(1, sort)"><i class="material-icons">
                                        first_page</i></a></li>
                                    <li class="waves-effect"><a href="@routes.RAJobController.rajobList(pageNum - 1, sort)"><i class="material-icons">
                                        chevron_left</i></a></li>
                                }
                                @if(beginIndexForPagination > 1) {
                                    <li class="waves-effect modal-trigger" href="#allPageModal" style="cursor: pointer;
                                        font-size: 20px;
                                        font-weight: bold">...</li>
                                }
                                @for(i <- (beginIndexForPagination + 0) to (endIndexForPagination + 0)) {
                                    <li @if(pageNum == i) {
                                        class="active"}><a href="@routes.RAJobController.rajobList(i, sort)">@i</a></li>
                                }
                                @if(endIndexForPagination < ((total - 1) / pageLimit + 1)) {
                                    <li class="waves-effect modal-trigger" href="#allPageModal" style="cursor: pointer;
                                        font-size: 20px;
                                        font-weight: bold">...</li>
                                }
                                @if((offset + count) >= total) {
                                    <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                        chevron_right</i></li>
                                    <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                        last_page</i></li>
                                } else {
                                    <li class="waves-effect"><a href="@routes.RAJobController.rajobList(pageNum + 1, sort)"><i class="material-icons">
                                        chevron_right</i></a></li>
                                    <li class="waves-effect"><a href="@routes.RAJobController.rajobList((total - 1) / pageLimit + 1, sort)"><i class="material-icons">
                                        last_page</i></a></li>
                                }
                            }else if(listType.equals("my enroll")){
                            @if(pageNum == 1) {
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    first_page</i></li>
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    chevron_left</i></li>
                            }
                            @if(beginIndexForPagination > 1) {
                                <li class="waves-effect modal-trigger" href="#enrollPageModal" style="cursor: pointer;
                                    font-size: 20px;
                                    font-weight: bold">...</li>
                            }

                            @if(endIndexForPagination < ((total - 1) / pageLimit + 1)) {
                                <li class="waves-effect modal-trigger" href="#enrollPageModal" style="cursor: pointer;
                                    font-size: 20px;
                                    font-weight: bold">...</li>
                            }

                            }else{
                            @if(pageNum == 1) {
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    first_page</i></li>
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    chevron_left</i></li>
                            } else {
                                <li class="waves-effect">
                                    <a href="#!" onclick="jumpToPage(1, '@sort', '@searchBody')">
                                        <i class="material-icons">first_page</i>
                                    </a>
                                </li>
                                <li class="waves-effect">
                                    <a href="#!" onclick="jumpToPage(@pageNum-1, '@sort', '@searchBody')">
                                        <i class="material-icons">chevron_left</i>
                                    </a>
                                </li>
                            }
                            @if(beginIndexForPagination > 1) {
                                <li class="waves-effect modal-trigger" href="#searchPageModal" style="cursor: pointer;
                                    font-size: 20px;
                                    font-weight: bold">...</li>
                            }
                            @for(i <- (beginIndexForPagination + 0) to (endIndexForPagination + 0)) {
                                <li @if(pageNum == i) {
                                    class="active"}>
                                    <a href="#!" onclick="jumpToPage(@i, '@sort', '@searchBody')">
                                    @i
                                    </a>
                                </li>
                            }
                            @if(endIndexForPagination < ((total - 1) / pageLimit + 1)) {
                                <li class="waves-effect modal-trigger" href="#searchPageModal" style="cursor: pointer;
                                    font-size: 20px;
                                    font-weight: bold">...</li>
                            }
                            @if((offset + count) >= total) {
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    chevron_right</i></li>
                                <li class="waves-effect disabled" style="color: #c3bfbf;"><i class="material-icons">
                                    last_page</i></li>
                            } else {
                                <li class="waves-effect">
                                    <a href="#!" onclick="jumpToPage(@pageNum+1, '@sort', '@searchBody')">
                                        <i class="material-icons">chevron_right</i>
                                    </a>
                                </li>
                                <li class="waves-effect">
                                    <a href="#!" onclick="jumpToPage((@total-1)/(@pageLimit)+1, '@sort', '@searchBody')">
                                        <i class="material-icons">last_page</i>
                                    </a>
                                </li>
                            }
                            }
                        </ul>
                    </div>
                </div>
            } else {
                <h5>No RA jobs registered yet.</h5>
            }
            <div id="allPageModal" class="modal">
                <div class="modal-content">
                    <h6>Select the page number you want to jump to</h6>
                    <div class="card z-depth-0">

                    @for(i <- (0) to ((((total - 1)/(pageLimit) + 1) - 1)/10)) {
                        <ul class="pagination center-align">
                        @for(j <- (i * 10 + 1) to (i * 10 + 10)) {
                            @if(j <= ((total - 1)/(pageLimit) + 1)) {
                                @if(j != pageNum) {
                                    <li class="waves-effect grey lighten-3"><a href='@routes.RAJobController.rajobList(j, sort)'>@j</a></li>
                                }else{
                                    <li class="waves-effect active"><a href="@routes.RAJobController.rajobList(j, sort)">@j</a></li>
                                }
                            }
                        }
                        </ul>
                    }
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-close waves-effect waves-green btn-flat">
                        Cancel</a>
                </div>
            </div>

            <div id="enrollPageModal" class="modal">
                <div class="modal-content">
                    <h6>Select the page number you want to jump to</h6>
                    <div class="card z-depth-0">

                    @for(i <- (0) to ((((total - 1)/(pageLimit) + 1) - 1)/10)) {
                        <ul class="pagination center-align">
                        @for(j <- (i * 10 + 1) to (i * 10 + 10)) {
                            @if(j <= ((total - 1)/(pageLimit) + 1)) {
                                @if(j != pageNum) {
                                    <li class="waves-effect grey lighten-3"><a href='@routes.ProjectController.getMyEnrolledProjects(j, sort)'>@j</a></li>
                                }else{
                                    <li class="waves-effect active"><a href="@routes.ProjectController.getMyEnrolledProjects(j, sort)">@j</a></li>
                                }
                            }
                        }
                        </ul>
                    }
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-close waves-effect waves-green btn-flat">
                        Cancel</a>
                </div>
            </div>

            <div id="searchPageModal" class="modal">
                <div class="modal-content">
                    <h6>Select the page number you want to jump to</h6>
                    <div class="card z-depth-0">

                    @for(i <- (0) to ((((total - 1)/(pageLimit) + 1) - 1)/10)) {
                        <ul class="pagination center-align">
                        @for(j <- (i * 10 + 1) to (i * 10 + 10)) {
                            @if(j <= ((total - 1)/(pageLimit) + 1)) {
                                @if(j != pageNum) {
                                    <li class="waves-effect grey lighten-3"><a href='#!' onclick="jumpToPage(@j, 'id', '@searchBody')">@j</a></li>
                                }else{
                                    <li class="waves-effect active"><a href="#!" onclick="jumpToPage(@j, 'id', '@searchBody')">@j</a></li>
                                }
                            }
                        }
                        </ul>
                    }
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#!" class="modal-close waves-effect waves-green btn-flat">
                        Cancel</a>
                </div>
            </div>        
              

        </div>
    </div>
}
